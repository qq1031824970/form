/*!
 * @form-create/component-naive-group v3.1.30
 * (c) 2018-2024 xaboy
 * Github https://github.com/xaboy/form-create with group
 * Released under the MIT License.
 */
import{defineComponent as e,markRaw as t,nextTick as o,createVNode as i,watch as s,mergeProps as r}from"vue";const n={type:(e,t)=>Object.prototype.toString.call(e)==="[object "+t+"]",Undef:e=>null==e,Element:e=>"object"==typeof e&&null!==e&&1===e.nodeType&&!n.Object(e),trueArray:e=>Array.isArray(e)&&e.length>0,Function(e){const t=this.getType(e);return"Function"===t||"AsyncFunction"===t},getType(e){const t=Object.prototype.toString.call(e);return/^\[object (.*)\]$/.exec(t)[1]},empty:e=>null==e||(!(!Array.isArray(e)||!Array.isArray(e)||e.length)||"string"==typeof e&&!e)};function l(e,t,o){e[t]=o}function a(e,t={},o){let i=!1;for(let s in t)if(Object.prototype.hasOwnProperty.call(t,s)){let r=t[s];if((i=Array.isArray(r))||n.Object(r)){let t=void 0===e[s];if(i)i=!1,t&&l(e,s,[]);else if(r._clone&&void 0!==o){if(!o){l(e,s,r._clone());continue}r=r.getRule(),t&&l(e,s,{})}else t&&l(e,s,{});e[s]=a(e[s],r,o)}else l(e,s,r),n.Undef(r)||(n.Undef(r.__json)||(e[s].__json=r.__json),n.Undef(r.__origin)||(e[s].__origin=r.__origin))}return void 0!==o&&Array.isArray(e)?e.filter((e=>!e||!e.__ctrl)):e}function u(e){return a({},{value:e}).value}["Date","Object","String","Boolean","Array","Number"].forEach((e=>{n[e]=function(t){return n.type(t,e)}}));const d=Object.assign||function(e){for(let t,o=1;o<arguments.length;o++)for(let i in t=arguments[o],t)Object.prototype.hasOwnProperty.call(t,i)&&l(e,i,t[i]);return e};!function(e,t){void 0===t&&(t={});var o=t.insertAt;if(e&&"undefined"!=typeof document){var i=document.head||document.getElementsByTagName("head")[0],s=document.createElement("style");s.type="text/css","top"===o&&i.firstChild?i.insertBefore(s,i.firstChild):i.appendChild(s),s.styleSheet?s.styleSheet.cssText=e:s.appendChild(document.createTextNode(e))}}('._fc-group{display:flex;flex-direction:column;justify-content:center;min-height:38px;width:100%}._fc-group-disabled ._fc-group-add,._fc-group-disabled ._fc-group-btn{cursor:not-allowed}._fc-group-handle{background-color:#fff;border:1px dashed #d9d9d9;border-radius:15px;bottom:-15px;display:flex;flex-direction:row;padding:3px 8px;position:absolute;right:30px}._fc-group-btn{cursor:pointer}._fc-group-idx{align-items:center;background:#eee;border-radius:15px;bottom:-15px;display:flex;font-weight:700;height:30px;justify-content:center;left:10px;position:absolute;width:30px}._fc-group-handle ._fc-group-btn+._fc-group-btn{margin-left:7px}._fc-group-container{border:1px dashed #d9d9d9;border-radius:5px;display:flex;flex-direction:column;margin:5px 5px 25px;padding:20px 20px 25px;position:relative}._fc-group-arrow{height:20px;position:relative;width:20px}._fc-group-arrow:before{border-left:2px solid #999;border-top:2px solid #999;content:"";height:9px;left:5px;position:absolute;top:8px;transform:rotate(45deg);width:9px}._fc-group-arrow._fc-group-down{transform:rotate(180deg)}._fc-group-plus-minus{cursor:pointer;height:20px;position:relative;width:20px}._fc-group-plus-minus:after,._fc-group-plus-minus:before{background-color:#409eff;content:"";height:2px;left:50%;position:absolute;top:50%;transform:translate(-50%,-50%);width:60%}._fc-group-plus-minus:before{transform:translate(-50%,-50%) rotate(90deg)}._fc-group-plus-minus._fc-group-minus:before{display:none}._fc-group-plus-minus._fc-group-minus:after{background-color:#f56c6c}._fc-group-add{border:1px solid rgba(64,158,255,.5);border-radius:15px;cursor:pointer;height:25px;width:25px}._fc-group-add._fc-group-plus-minus:after,._fc-group-add._fc-group-plus-minus:before{width:50%}');var c=e({name:"fcGroup",props:{field:String,rule:Array,expand:Number,options:Object,button:{type:Boolean,default:!0},max:{type:Number,default:0},min:{type:Number,default:0},modelValue:{type:Array,default:()=>[]},defaultValue:Object,sortBtn:{type:Boolean,default:!0},disabled:{type:Boolean,default:!1},syncDisabled:{type:Boolean,default:!0},onBeforeRemove:{type:Function,default:()=>{}},onBeforeAdd:{type:Function,default:()=>{}},formCreateInject:Object,parse:Function},data(){return{len:0,cacheRule:{},cacheValue:{},sort:[],form:t(this.formCreateInject.form.$form())}},emits:["update:modelValue","change","itemMounted","remove","add"],watch:{rule:{handler(e,t){Object.keys(this.cacheRule).forEach((o=>{const i=this.cacheRule[o];if(i.$f){const o=i.$f.formData();if(e===t)i.$f.deferSyncValue((()=>{a(i.rule,e),i.$f.setValue(o)}),!0);else{const t=i.$f.formData();i.$f.once("reloading",(()=>{i.$f.setValue(t)})),i.rule=u(e)}}}))},deep:!0},disabled(e){if(this.syncDisabled){const t=this.cacheRule;Object.keys(t).forEach((o=>{t[o].$f.disabled(e)}))}},expand(e){let t=e-this.modelValue.length;t>0&&this.expandRule(t)},modelValue:{handler(e){e=e||[];let t=Object.keys(this.sort),o=t.length,i=o-e.length;if(i<0){for(let t=i;t<0;t++)this.addRule(e.length+t,!0);for(let i=0;i<o;i++)this.setValue(t[i],e[i])}else{if(i>0)for(let e=0;e<i;e++)this.removeRule(t[o-e-1]);e.forEach(((o,i)=>{this.setValue(t[i],e[i])}))}},deep:!0}},methods:{_value(e){return e&&(t=e,o=this.field,{}.hasOwnProperty.call(t,o))?e[this.field]:e;var t,o},cache(e,t){this.cacheValue[e]=JSON.stringify(t)},input(e){this.$emit("update:modelValue",e),this.$emit("change",e)},formData(e,t){const o=this.cacheRule,i=this.sort;if(i.filter((e=>o[e].$f)).length!==i.length)return;const s=i.map((o=>{const i=e===o?t:{...this.cacheRule[o].$f.form},s=this.field?i[this.field]||null:i;return this.cache(o,s),s}));this.input(s)},setValue(e,t){const o=this.field;o&&(t={[o]:this._value(t)}),this.cacheValue[e]!==JSON.stringify(o?t[o]:t)&&this.cache(e,t)},addRule(e,t){const i=this.formCreateInject.form.copyRules(this.rule||[]),s=this.options?{...this.options}:{submitBtn:!1,resetBtn:!1};if(this.defaultValue){s.formData||(s.formData={});const e=u(this.defaultValue);!function(){d.apply(this,arguments)}(s.formData,this.field?{[this.field]:e}:e)}this.parse&&this.parse({rule:i,options:s,index:this.sort.length}),this.cacheRule[++this.len]={rule:i,options:s},t&&o((()=>this.$emit("add",i,Object.keys(this.cacheRule).length-1)))},add$f(e,t,i){this.cacheRule[t].$f=i,o((()=>{this.syncDisabled&&i.disabled(this.disabled),this.$emit("itemMounted",i,Object.keys(this.cacheRule).indexOf(t))}))},removeRule(e,t){const i=Object.keys(this.cacheRule).indexOf(e);delete this.cacheRule[e],delete this.cacheValue[e],t&&o((()=>this.$emit("remove",i)))},add(e){if(this.disabled||!1===this.onBeforeAdd(this.modelValue))return;const t=[...this.modelValue];t.push(this.defaultValue?u(this.defaultValue):this.field?null:{}),this.input(t)},del(e,t){if(this.disabled||!1===this.onBeforeRemove(this.modelValue,e))return;this.removeRule(t,!0);const o=[...this.modelValue];o.splice(e,1),this.input(o)},addIcon(e){return i("div",{class:"_fc-group-btn _fc-group-plus-minus",onClick:this.add},null)},delIcon(e,t){return i("div",{class:"_fc-group-btn _fc-group-plus-minus _fc-group-minus",onClick:()=>this.del(e,t)},null)},sortUpIcon(e){return i("div",{class:"_fc-group-btn _fc-group-arrow _fc-group-up",onClick:()=>this.changeSort(e,-1)},null)},sortDownIcon(e){return i("div",{class:"_fc-group-btn _fc-group-arrow _fc-group-down",onClick:()=>this.changeSort(e,1)},null)},changeSort(e,t){const o=this.sort[e];this.sort[e]=this.sort[e+t],this.sort[e+t]=o,this.formData(0)},makeIcon(e,t,o){if(this.$slots.button)return this.$slots.button({total:e,index:t,vm:this,key:o,del:()=>this.del(t,o),add:this.add});const i=[];return(!this.max||e<this.max)&&e===t+1&&i.push(this.addIcon(o)),e>this.min&&i.push(this.delIcon(t,o)),this.sortBtn&&t&&i.push(this.sortUpIcon(t)),this.sortBtn&&t!==e-1&&i.push(this.sortDownIcon(t)),i},emitEvent(e,t,o,i){this.$emit(e,...t,this.cacheRule[i].$f,o)},expandRule(e){for(let t=0;t<e;t++)this.addRule(t)}},created(){s((()=>({...this.cacheRule})),(e=>{this.sort=Object.keys(e)}),{immediate:!0});const e=(this.expand||0)-this.modelValue.length;for(let e=0;e<this.modelValue.length;e++)this.addRule(e);e>0&&this.expandRule(e)},render(){const e=this.sort,t=this.button,o=this.form,s=this.disabled,n=0===e.length?this.$slots.default?this.$slots.default({vm:this,add:this.add}):i("div",{key:"a_def",class:"_fc-group-plus-minus _fc-group-add fc-clock",onClick:this.add},null):e.map(((n,l)=>{const{rule:a,options:u}=this.cacheRule[n],d=t&&!s?this.makeIcon(e.length,l,n):[];return i("div",{class:"_fc-group-container",key:n},[i(o,r({key:n},{"onUpdate:modelValue":e=>this.formData(n,e),"onEmit-event":(e,...t)=>this.emitEvent(e,t,l,n),"onUpdate:api":e=>this.add$f(l,n,e),inFor:!0,modelValue:this.field?{[this.field]:this._value(this.modelValue[l])}:this.modelValue[l],rule:a,option:u,extendOption:!0}),null),i("div",{class:"_fc-group-idx"},[l+1]),d.length?i("div",{class:"_fc-group-handle fc-clock"},[d]):null])}));return i("div",{key:"con",class:"_fc-group "+(s?"_fc-group-disabled":"")},[n])}});export{c as default};
